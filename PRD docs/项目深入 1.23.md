# 项目深入规划 1.23

> **文档更新时间：** 2026-01-23

---

## 一、当前产品主要功能点

| 模块 | 功能 | 状态 |
|---|---|---|
| **ASR 语音识别** | 用户语音转文字（实时流式） | ✅ 基础完成 |
| **Intv LLM 对话** | 访谈员 AI 与用户对话交互 | ✅ 基础完成 |
| **TTS 语音合成** | AI 回复转语音播放 | ✅ 后端完成，🚧 前端联调中 |
| **前端页面** | index/interview/records/me 四页面 | ✅ 框架完成 |
| **本地数据库** | SQLite 存储对话记录 | ✅ 基础完成 |

---

## 二、腾讯云数据库配置

> [!IMPORTANT]
> 请提供以下信息以完成数据库接入

### 需要您提供的信息：

> [!NOTE]
> **用户已选择：PostgreSQL** ✅

1. **数据库类型**
   - ~~您购买的是哪种数据库？（如：PostgreSQL、MySQL、TDSQL 等）~~
   - **已确认：PostgreSQL**

2. **连接信息**
   - **内网/外网地址**：`xxx.sql.tencentcdb.com`
   - **端口号**：如 `5432`（PostgreSQL）或 `3306`（MySQL）
   - **数据库名**：如 `memoir_db`
   - **用户名**：如 `root` 或自定义用户
   - **密码**：数据库登录密码

3. **安全配置**
   - 是否已开启外网访问？（本地开发需要外网，生产部署可用内网）
   - 是否配置了安全组/白名单？

4. **SSL 选项**
   - 是否需要 SSL 加密连接？（如需要，请下载证书文件）

### 可选信息：

- **腾讯云对象存储 (COS)** 配置（用于存储用户语音文件）：
   - Bucket 名称
   - Region 地区
   - SecretId & SecretKey

---

## 三、核心行动规划

基于《服务端流程文档与数据库结构设计》，以下是分阶段的行动计划：

---

### 阶段一：基础设施升级 🔧

#### 1.1 腾讯云数据库接入
> **风险等级：中** - 涉及数据迁移与连接配置变更

**行动点与验证标准：**

- [ ] **获取腾讯云数据库连接信息**
  - ✅ **验证点：** 用户提供完整信息表格（数据库类型、地址、端口、用户名、密码）
  - 📖 **参考文档：** `腾讯云数据库信息查找指南.md`

- [ ] **安装数据库驱动依赖**
  - ✅ **验证点：** 运行 `pip install <驱动>` 成功，无报错
  - 📦 **MySQL 驱动：** `pymysql` 或 `mysqlclient`
  - 📦 **PostgreSQL 驱动：** `psycopg2-binary`

- [ ] **修改 `backend/database.py` 连接配置**
  - ✅ **验证点：** 代码中 SQLite 连接字符串已替换为云数据库连接字符串
  - 🔍 **检查项：** 连接字符串格式正确（如 `postgresql://user:pass@host:port/dbname`）

- [ ] **测试数据库连接**
  - ✅ **验证点：** 运行测试脚本，终端输出 "数据库连接成功"
  - 🧪 **测试方式：** 创建 `test_db_connection.py` 脚本，尝试连接并查询数据库版本

- [ ] **创建数据库表结构**
  - ✅ **验证点：** 在数据库管理工具（或腾讯云控制台）中能看到 16 张表
  - 📋 **表清单：** sys_config, base_models, users, stage, topic, shot, character, intv_llm_session, chat_cachepool, story_board, hint_board, LLM_processed, ASR_processed, TTS_processed, interview_original_text, interview_original_voice

- [ ] **验证表结构正确性**
  - ✅ **验证点：** 运行 `DESCRIBE <表名>` 或 `\d <表名>`，字段类型与设计文档一致
  - 🔍 **重点检查：** 外键关联是否正确（stage ← topic ← shot ← character）

**风险说明：**
- ⚠️ 现有 SQLite 数据已确认可丢弃，无需迁移
- ⚠️ 数据库驱动需要安装新依赖（如 `psycopg2` 或 `pymysql`）
- ⚠️ 外网访问需要配置安全组，避免连接被拒绝

---

#### 1.2 腾讯云对象存储 (COS) 接入
> **风险等级：低** - 新增模块，不影响现有功能

**行动点：**
- [ ] 获取 COS 配置信息
- [ ] 创建 `backend/cos_service.py` 服务模块
- [ ] 实现语音文件上传接口
- [ ] 实现 URL 获取逻辑

---

### 阶段二：数据库结构实现 🗄️

#### 2.1 系统配置模块
- [ ] 创建 `sys_config` 表及初始化脚本
- [ ] 创建 `base_models` 表，录入模型配置
- [ ] 实现配置读取工具函数

---

#### 2.2 用户与权限模块
- [ ] 创建 `users` 表
- [ ] 实现微信登录后用户信息存储逻辑
  - [ ] 小功能：微信 OpenID 获取
  - [ ] 小功能：用户首次登录自动注册

---

#### 2.3 回忆核心容器模块
> **风险等级：高** - 这是产品核心数据结构

**行动点：**
- [ ] 创建 `stage`（舞台）表
- [ ] 创建 `topic`（话题）表，外键关联 stage
- [ ] 创建 `shot`（镜头）表，外键关联 topic
- [ ] 创建 `character`（人物）表，外键关联 shot
- [ ] 实现层级关系维护逻辑

**风险说明：**
- ⚠️ 外键关联顺序必须正确：Stage → Topic → Shot → Character
- ⚠️ 后续所有 Agent 逻辑依赖此结构

---

### 阶段三：Agent 工作流实现 🤖

#### 3.1 Intv Agent（访谈员）完善
> **风险等级：中** - 涉及现有代码重构

**行动点：**
- [ ] 创建 `intv_llm_session` 表
- [ ] 实现 Session 管理逻辑
  - [ ] Session 创建与过期判断
  - [ ] Session 字数统计
  - [ ] `previous_response_id` 传递
- [ ] 创建 `interview_original_text` 表，存储对话原文
- [ ] 创建 `interview_original_voice` 表，存储语音 URL
- [ ] 实现 `intv_input` 组装逻辑（pc + ot + ht 拼接）
- [ ] 接入 Response API 的 Session 缓存模式

**风险说明：**
- ⚠️ 需修改现有 `main.py` WebSocket 处理逻辑
- ⚠️ 需确认火山引擎 Response API 的 Session 缓存参数

---

#### 3.2 对话缓存池实现
> **风险等级：中**

**行动点：**
- [ ] 创建 `chat_cachepool` 表
- [ ] 实现缓存池字数统计与阈值判断
- [ ] 实现缓存池内容拼接（U: / I: 前缀）
- [ ] 阈值触发后调用 Stn Agent 逻辑

---

#### 3.3 Stn Agent（速记员）实现
> **风险等级：高** - 全新 Agent，涉及复杂 JSON 解析

**行动点：**
- [ ] 实现并发控制（按 user_id 队列）
- [ ] 创建 `story_board` 表
- [ ] 实现 `stn_input` 组装逻辑
- [ ] 调用 Stn LLM（需配置新 Prompt）
- [ ] 解析 Stn LLM 返回的 JSON 结构
- [ ] 实现回忆数据库写入逻辑
  - [ ] process_type 判断（n/u/k）
  - [ ] Stage → Topic → Shot → Character 顺序写入
- [ ] Story Board 条目生成与 `is_current` 标记

**风险说明：**
- ⚠️ JSON 解析失败需有完备的重试与错误处理
- ⚠️ 需设计并测试 Stn LLM 的 Prompt 以确保输出格式稳定

---

#### 3.4 Dir Agent（导演）实现
> **风险等级：中**

**行动点：**
- [ ] 创建 `hint_board` 表
- [ ] 实现 `dir_input` 组装（取 is_current=true 的 Story Board）
- [ ] 调用 Dir LLM（需配置新 Prompt）
- [ ] 解析 Dir LLM 返回的 Hint 内容
- [ ] Hint Board 写入与更新

---

### 阶段四：模型计费与追踪 💰

#### 4.1 模型调用记录
- [ ] 创建 `LLM_processed` 表
- [ ] 创建 `ASR_processed` 表
- [ ] 创建 `TTS_processed` 表
- [ ] 实现费用计算逻辑（按文档公式）
- [ ] 集成到各 Agent 调用结束后的异步任务

---

### 阶段五：前端联调与优化 📱

#### 5.1 现有 UI 优化
- [ ] index 首页优化
- [ ] interview 对话页交互体验提升
- [ ] records 记录页展示逻辑
- [ ] me 个人页完善

#### 5.2 新增功能前端
- [ ] 回忆内容展示页面（Stage/Topic/Shot 可视化）
- [ ] 人物管理页面

---

## 四、建议执行顺序

```mermaid
graph TD
    A[阶段一: 基础设施] --> B[阶段二: 数据库结构]
    B --> C[阶段三: Agent 工作流]
    C --> D[阶段四: 计费追踪]
    B --> E[阶段五: 前端联调]
    C --> E
```

**推荐顺序：**
1. **优先完成阶段一**（腾讯数据库接入），解除基础设施瓶颈
2. **按顺序完成阶段二**（数据表创建），为 Agent 逻辑打基础
3. **分步实现阶段三**（从 Intv → 缓存池 → Stn → Dir）
4. **并行进行阶段五**（前端优化可与后端开发同步）

---

## 五、待澄清事项

> [!NOTE]
> 以下问题需要您确认后再开始开发

1. **数据库选型确认**：腾讯云购买的具体是哪种数据库？
2. **现有数据处理**：SQLite 中的测试数据是否需要迁移？
3. **微信登录**：是否已经有微信登录的 AppSecret 配置？
4. **Prompt 设计**：Stn/Dir Agent 的 Prompt 是否需要我协助设计？

---

## 六、风险汇总

| 风险项 | 级别 | 说明 | 缓解措施 |
|---|---|---|---|
| 数据库迁移 | 中 | SQLite → 云数据库 | 先备份，分步迁移 |
| Intv Agent 重构 | 中 | 现有代码需调整 | 保留旧接口，逐步替换 |
| Stn LLM JSON 解析 | 高 | 输出格式不稳定 | 设计严格 Prompt + 重试机制 |
| 外键关联顺序 | 高 | 写入顺序错误会破坏数据 | 严格按 S→T→O→C 顺序 |
| 火山引擎 API 参数 | 中 | Session 缓存机制未实测 | 查阅文档 + 请求客服确认 |
