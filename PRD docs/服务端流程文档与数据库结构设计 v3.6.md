# 服务端流程文档与数据库结构设计 v3.6
#1. 工作手记#

# 一、概念定义
## 1. Agent
* **访谈员 Agent (intv agent)**：负责前端与用户的实时交互。包含 ASR（语音转文字）、Intv LLM（对话大脑）、TTS（文字转语音）及相关逻辑。
* **速记员 Agent (stn agent)**：负责后台“整理笔记”。它将聊天记录分批次提取成标准化的回忆结构（Stage/Topic/Shot/Character），并增量更新故事板（storyboard）。
* **导演 Agent (dir agent)**：负责“全局把控”。它根据故事板的进展提出后续采访建议，并更新至提示板（hintboard），引导访谈员深入挖掘。

## 2. 采访内容中转
* **user_original_text**（用户每轮的输入内容）：用户打字，或语音输入转文字后的原文；
* **chat_cachepool**（对话缓存池）： 这是一个临时的对话存放区。为了节省成本，系统不会每轮都触发速记员逻辑及其后的导演逻辑，而是等池内字数攒够 {{config.cache_pool_limit}} 后再统一处理。 对话缓存池中的内容需做数据持久化。
* **storyboard**（sb，故事板）： 这是用户回忆内容的增量大纲，方便速记员 agent、导演 agent 了解用户的回忆。
  * 生产方： stn agent，通过对 **chat_cachepool** 内容进行分析输出的结构化条目；
  * 使用方：
    * 供 stn agent 了解用户回忆内容，得出“新回忆如何入库”（即：新增还是更新现有 stage/topic/shot/character）；
    * 供 dir agent 了解用户回忆内容，产出“导演提示问题”。
  * 结构：新回忆写入 storyboard 时，以**增量**进行更新， stage/topic/shot/character 进行混排，通过 story_type 区分。
* **hintboard**（HB，导演提示板）：由 dir agent 生成的，供 intv agent 采访时参考的文本。
* **Session**：
  * Session：一场对话。通常是指一段连续的、具有上下文关联的多轮对话的集合， 如需实现连续对话，需要在代码中手动携带上下文信息（previous_response_id）来维持会话状态。
  * Session 缓存：一种动态缓存机制，专为多轮对话场景设计，会自动管理对话上下文， 适合多轮对话、多轮工具调用、角色扮演等需要多次传入和维持相同上下文的场景。与静态的前缀缓存不同，session 缓存不仅会存储初始的对话信息，还会随着每一轮新的对话动态更新缓存内容。使用 session 缓存可以减少重复处理相同上下文的开销，从而提升性能并降低推理成本。
    * 启用缓存：在创建对话请求时，需要在 extra_body 参数中设置 "caching": {"type": "enabled"} 来开启缓存功能。
    * 关联对话：在进行后续的连续对话时，需要在请求中传入 previous_response_id 参数，其值为上一轮对话的响应ID，这样API就能自动识别并应用之前缓存的会话上下文。
    * 注意事项：session 缓存和前缀缓存不能同时使用。
# 二、研发规范
## 1. 配置规范
* 文档中凡是出现 {{config.key_name}} 格式的内容，均代表该值需从 sys_config 表中根据 config_key 动态获取。
* 若引用的是模型，系统需根据 sys_config 中的 ID 进一步关联 base_models 表获取 API 参数。

## 2. LLM API 调用参数规范
请严格遵守以下参数构造逻辑，禁止使用 API 文档中互斥的字段（如 instructions 与 caching 不能混用）。
### 1\. 通用配置
* **System Prompt 处理：** 由于我们要使用 Session Caching，**严禁**使用 API 的 instructions 字段。所有 System Prompt 必须封装在 input 数组的第一条，角色为 system。
* **JSON 模式：** 对于 Stn Agent，必须在请求体中设置 text 字段强制 JSON 输出："text": { "format": { "type": "json_object" } }
### 2\. 各 LLM 参数映射表
请在编写代码时，根据当前 Agent 类型，严格匹配以下参数配置：
| **参数项**                  | **Intv LLM**                                       | **Stn LLM**                     | **Dir LLM**                                        |
|--------------------------|----------------------------------------------------|---------------------------------|----------------------------------------------------|
| **Caching (缓存策略)**       | **Enabled** (Session 模式)                           | **Disabled** (或仅 Prefix)        | **Enabled** (Session 模式)                           |
| **Previous Response ID** | **有值时：** 传入 previous_response_id<br>**无值时：** 不传此字段 | **永远不传**<br>(保持无状态/单轮任务)        | **有值时：** 传入 previous_response_id<br>**无值时：** 不传此字段 |
| **Stream (流式)**          | **True** (需实时返回文字)                                 | **False** (这是后台任务，等待完整 JSON 即可) | **False** (后台任务)                                   |

# 三、服务端流程
## 1. Intv agent（采访员）工作流
1. **采访初始化**：本版本暂无初始化流程，此流程先占位。
2. **用户输入内容**：
   * 用户可通过语音/打字输入内容。若采用语音输入：
     * 在点击“讲述”按钮后，开启录音并调用 ASR 模型 （取 base_models 表中 model_id == {{config.intv_asr_model}} 对应的 api_model_id）：
       * 若 ASR 调用成功（返回了文字）：则流式输出用户字幕；
       * 若 ASR 调用失败，后端报错：“念念有点听不清，麻烦稍后再试下哦（intvasrE）”
     * 用户发送语音后， 记录 ASR 消耗：记录存入表 ASR_processed：
       * model_id == {{config.intv_asr_model}}（直接存配置项中的内部 ID）；
       * 字段 duration == 用户讲话时长（s）；
   * 用户点击发送按钮后，视为本轮用户输入完成。变量 user_original_text == 用户打字或 ASR 转写的内容。其后做 2 步异步操作：
     * **用户输入入库**：
       1. 先进行文字入库：输入文字存入表：interview_original_text。字段赋值：
          * original_text == user_original_text；
          * speaker_type == 0（用户）。
       2. 后进行语音入库（若有）： 将录制的语音转为 .mp3 并调用腾讯云 COS，获取 url 后存入表 interview_original_voice，字段赋值：
          * original_voice_url == url；
          * speaker_type == 0（用户）；
          * link_original_text_id == 关联本轮 interview_original_text_id；
          * 更新 interview_original_text 表：将 ID == link_original_text_id 的记录，字段 has_voice 更新为 True。
     * **更新对话缓存池，并判断是否调用 stn agent**：在 narration_status 表中赋值（此 user_id）chat_cachepool_content ==（按顺序拼接）已有内容 + "U:" + user_original_text + 空格。其后触发对话缓存池判断：
       * **触发条件判断**：当前缓存池 chat_cachepool_content 总字数 > {{config.cache_pool_limit}} 时，调用 Stn Agent：
       * **执行逻辑（采用快照机制防止并发丢失）**：
         1. **快照提取**：将当前数据库中的 chat_cachepool_content 赋值给临时变量 temp_batch_content；
         2. **立即清空**：原子性操作清空数据库中的 chat_cachepool_content（确保后续新进来的用户输入不会被误删）；
         3. **异步调用**：向 Stn Agent 传入 temp_batch_content 进行处理。
3. **Session 处理**：先判断是否有可用的 intv_session。
   * 判断条件：查阅 narration_status 表（此 user_id），满足以下任一条件则视为**无可用** intv_session：
     * intv_llm_session_id 为空；// 还没有创建过
     * intv_llm_session_word_count > {{config.intv_llm_session_word_limit}}；// 字数超限
     * intv_llm_session_expire_at - 当前时间 < {{config.intv_llm_session_expire_buf}}；// 时间即将超限
   * 若有可用 session，更新 narration_status 表（此 user_id），赋值：intv_llm_session_word_count == 已有字数 + 本轮 user_original_text 的字数；
   * 若无可用 session，则：
     1. 为新 session 准备对话前情提要：变量 intv_llm_previous_content == 查询（此 user_id）interview_original_text 表，按 created_time 倒序取出最新 9 条对话（随后需倒序排列恢复时间正序），在每条对话前拼接：
        * speaker_type == 1 时拼接"I:"（AI）；
        * speaker_type == 0 时拼接"U:"（用户）；
     2. 新建或重置（intv 的）session 信息，在 narration_status 表中（为此 user_id）赋值：
        * intv_llm_session_word_count == intv_llm_previous_content 总字数 + 本轮 user_original_text 的字数；
        * intv_llm_session_expire_at == 当前时间 +{{config.intv_llm_session_expire_duration}}；// 设置新的过期时间。
     3. 切断旧 session 的联系：intv_llm_session_previous_response_id 置为空。
4. **判断 hintboard 是否更新**：判断条件： 查询 hintboard 表，获取（此 user_id）最新创建的一条记录（按 created_time 倒序取 limit 1）。若该记录的 hint_id == narration_status 表中（此 user_id）的 intv_llm_hint_id，则为未更新。若 hintboard 已更新：
   * 变量 intv_llm_hint_content == hintboard 表中最新创建的 hint_content
   * narration_status 表赋值 intv_llm_hint_id == hintboard 表中最新 id（均为此 user_id）
5. **配置本轮 intv_llm_input**：
   * 取 prompt：在 prompt_config 表中，取 llm_type == 0 且 is_active == ture 且 prompt_id 最大的记录，intv_prompt == prompt_content；
   * 需要判断本轮 intv LLM 对话是否新建了 session： 
     * 若新建了 session，intv_llm_input == [ {role: system, content: intv_prompt}, {role: assistant, content: “ pc:intv_llm_previous_content”}, {role: user, content: "ot:user_original_text;hc:intv_llm_hint_content"} ]
     * 若未新建 session，intv_llm_input == [ {role: user, content: "ot:user_original_text;hc:intv_llm_hint_content"}
6. **调用 Intv LLM Response API**：
   * 入参：
     * model_id == 查询 base_models 表获取 api_model_id（条件：model_id == {{config.intv_llm_model}}）；
     * input == intv_llm_input；
     * previous_response_id == intv_llm_session_previous_response_id（为空则不传）；
     * expire_at == intv_llm_session_expire_at；
     * temperature == {{config.intv_llm_temp}}。
   * 当开始接收到 LLM 流式输出文字，视为 Intv LLM 调用成功。若遇报错则重试 2 次调用。若仍失败，则后端提示：“哎呀，念念开小差啦，麻烦稍后再下试哦（intvllmE）”
7. **Intv Agent 输出与存储**：
   * 流式输出文字：Intv LLM 调用成功后，客户端流式输出 AI 字幕。
   * 流式输出语音：流式输出 AI 字幕的同时，根据流式接收的文字流式调用 TTS 模型 （取 base_models 表中 model_id == {{config.intv_tts_model}} 对应的 api_model_id），请求**双向流式 API** 开始播放语音。若遇报错则重试 2 次调用。若仍失败，则后端提示： 提示“哎呀，念念嗓子有点哑了（intvttsE）”
   * 接收完全部文字后，进行以下异步操作：
     * 存储 Intv LLM 回复：写入表 interview_original_text，赋值：
       * original_text == intv_text
       * speaker_type == 1（AI）
     * 记录 Intv LLM 调用： 根据 SDK 返回的 token 消耗，写入表 LLM_processed，赋值：
       * agent == "Intv"
       * model_id == {{config.intv_llm_model}}（直接存配置项中的内部 ID）
       * process_duration == 从调用到成功收到回复的时长，由系统计算，单位：毫秒
       * total_tokens == SDK 返回的 total_tokens
       * prompt_tokens == SDK 返回的 prompt_tokens
       * completion_tokens == SDK 返回的 completion_tokens
       * cached_tokens == SDK 返回的 cached_tokens
     * Narration_status 表配置更新：写入表 narration_status，（为此 user_id）赋值：
       * intv_llm_session_previous_response_id == LLM 返回的 previous_response_id
       * intv_llm_previous_content 置为空
       * intv_llm_session_word_count == 自增LLM 返回文本字数
       * intv_llm_session_id == LLM 返回的 session id
       * chat_cachepool_content == 当前内容 + "I:" + intv_text + 空格
   * 当语音流传输完毕（而不是播放完毕），且 Intv LLM 回复存储完成后：
     1. 先存储 AI 语音： 将接收的语音转为 .mp3 并上传至腾讯云 COS，获取 url。随后写入表： interview_original_voice，赋值：
        * original_voice_url == url
        * speaker_type == 1（AI）
        * link_original_text_id == 关联本轮 interview_original_text_id；
        * 更新 interview_original_text 表：将 ID == link_original_text_id 的记录，字段 has_voice 更新为 True。
     2. 再记录 Intv TTS 调用：写入表 TTS_processed，赋值：
        * model_id == {{config.intv_tts_model}}（直接存配置项中的内部 ID）；
        * link_original_text_id == 关联本轮 interview_original_text_id；
        * link_original_voice_id == 关联本轮 interview_original_voice_id；
## 2. Stn agent（速记员）工作流
1. **并发控制**：
   * **基于 User_ID 的任务队列**：系统需维护一个针对该用户的串行任务队列（FIFO）。
   * **入队逻辑**：当 Intv Agent 触发 Stn 请求时，若该用户当前无正在执行的 Stn 任务，则立即执行；若已有任务在运行，则将新请求放入队列等待。
   * **出队执行**：当前任务执行完毕（无论成功写入数据库还是发生异常报错）后，系统必须自动检查队列，若有积压任务，则取出下一条继续执行，确保同一用户的 Stn 任务严格按顺序单线程处理。
2. **Session 处理**：先判断是否有可用的 stn_session。
   * 判断条件：查阅 narration_status 表（此 user_id），满足以下任一条件则视为**无可用** stn_session：
     * stn_llm_session_id 为空；// 还没有创建过
     * stn_llm_session_word_count > {{config.stn_llm_session_word_limit}}；// 字数超限
     * stn_llm_session_expire_at - 当前时间 < {{config.stn_llm_session_expire_buf}}；// 时间即将超限
   * 若有可用 session:
     * **获取 Storyboard 未处理记录**：stn_storyboard_context == storyboard  表中 stn_processed_status == 查询 storyboard 表，（此 user_id）stn_processed_status == 0，按照 created_time 正序排列，将 story_content 全量拼接。在拼接内容的同时，记录下这批数据中**最大的 ID**，记为变量 max_stn_read_id。
     * **更新 narration_status 表**，（为此 user_id）赋值：stn_llm_session_word_count == 已有字数 + stn_storyboard_context 字数 + 本轮 cachepool_content 的字数
   * 若无可用 session，则：
     1. **获取 Storyboard 完整记录**：stn_storyboard_context == 查询 storyboard 表，按（此 user_id）created_time 倒序取 {{config.max_sb_context}} 条记录（随后恢复正序），将 story_content 全量拼接。
     2. 新建或重置（stn 的）session 信息，在 narration_status 表中（为此 user_id）赋值：
        * stn_llm_session_word_count == stn_storyboard_context 字数 + 本轮 cachepool_content 的字数；
        * stn_llm_session_expire_at == 当前时间 +{{config.stn_llm_session_expire_duration}}；// 设置新的过期时间。
     3. 切断旧 session 的联系：stn_llm_session_previous_response_id 置为空。
3. **配置本轮 stn_llm_input**：
   * 取 prompt：在 prompt_config 表中，取 llm_type == 1 且 is_active == ture 且 prompt_id 最大的记录，stn_prompt == prompt_content；
   * stn_llm_input == [ {role: system, content: stn_prompt}, {role: user, content: “sb:stn_storyboard_context; uc:stn_unprocessed_content; cp:cachepool_content”}。注意：
     * stn_unprocessed_content 为累计未成功处理内容。
       * 在本轮调用前，uc = 上一次未成功处理内容；
       - 本轮调用失败（包括重试多次仍失败）：将本轮 cachepool_content 与 uc 拼接；
       - 本轮调用成功：uc 清空。
     * sb/uc/cp 为空则不参与拼接；
4. **调用 Stn LLM Response API**：
   * 入参：
     * model_id == 查询 base_models 表获取 api_model_id（条件：model_id == {{config.stn_llm_model}}）；
     * input == stn_llm_input；
     * previous_response_id == stn_llm_session_previous_response_id（为空则不传）；
     * expire_at == stn_llm_session_expire_at；
     * temperature == {{config.stn_llm_temp}}。
   * 判断 LLM 是否回复成功：
     * 若 LLM 返回了内容，则判定为回复成功：
       * 记录 Stn LLM 调用： 根据模型返回的 token 消耗，写入 LLM_processed 表，赋值：
         * agent == "Stn"
         * model_id == {{config.stn_llm_model}}（直接存配置项中的内部 ID）
         * process_duration == 从调用到成功收到回复的时长，由系统计算，单位：毫秒
         * total_tokens == SDK 返回的 total_tokens
         * prompt_tokens == SDK 返回的 prompt_tokens
         * completion_tokens == SDK 返回的 completion_tokens
         * cached_tokens == SDK 返回的 cached_tokens
       * 清除之前（有可能的）处理失败的内容：将 narration_status 表中（此 user_id）stn_unprocessed_content 置空。
     * 若 LLM 回复报错，则重试 2 次调用。若仍然回复失败，则：
       * 后端提示“诶？刚才念念记东西时开了个小差（stnllmRE）”；
       * **记录处理失败内容**：写入 narration_status 表（筛选 user_id == 当前用户），stn_unprocessed_content == cachepool_content
   * 判断 JSON 是否解析成功：
     * 若 JSON 解析失败， 则重试 2 次调用。若仍然回复失败，则：
       * 后端提示“诶？刚才念念记东西时开了个小差（stnllmJE）”；
       * **记录处理失败内容**：写入 narration_status 表，（此 user_id）stn_unprocessed_content == cachepool_content
     * 若 JSON 解析成功，则进入下一步。
     * Stn LLM 输出应为标准的 JSON 格式：
```
{
  "type": "memory",
  "memory_content": {
    "S": [
      { "pt": "n", "tid": "s1", "title": "舞台标题", "summary": "...", "content": "..." },
      { "pt": "u", "id": 101, "summary": "..." }
    ],
    "T": [
      { "pt": "n", "tid": "t1", "title": "话题标题", "content": "..." }
    ],
    "O": [
      { "pt": "n", "tid": "o1", "title": "镜头标题", "shot_type": 2 }
    ],
    "C": [
      { "pt": "n", "tid": "c1", "name": "人物A", "relation": "..." }
    ],
    "R": [
      { "type": "link", "src": "t1", "tgt": "s1" },
      { "type": "link", "src": "c1", "tgt": "o1", "evaluation": "..." },
      { "type": "unlink", "src": "id:50", "tgt": "id:88" }
    ]
  }
}
```
5. **Stn 输出成功后的处理**： 
* **提取规范**：因 JSON 由 LLM 输出，为保证提取稳定性，需采用 Regex 提取逻辑。
* **数据库存储回忆**：
  1. 准备工作：
     * 解析 JSON（根节点为 Object），直接提取 memory_content 对象。
     * 后端在内存中建立一个临时对照表 id_map，用于记录 临时 ID 到 真实 ID 的对应关系。
  2. 实体入库 (S -> T -> O -> C)
     * 按顺序遍历 memory_content 中的 S, T, O, C 数组。
     * 若 pt == "n" (新增)：
       1. 将数据写入数据库（此时暂不处理父级外键）。
       2. 获取数据库生成的自增 ID。
       3. 在 id_map 中记录：id_map[tid] = 自增ID。
     * 若 pt == "u" (更新)：则视为实体级全量更新：后端需将该实体对应表中的所有可写字段，以 LLM 输出内容为准进行覆盖式更新；LLM 未输出的字段视为保持原值，不得写 NULL。
  3. ⠀建立关系 (R)
     * 遍历 memory_content 中的 R 数组，解析 src (源) 和 tgt (目标)：
       * 如果 ID 是临时的（如 "t1"）：去 id_map 查出真实 ID。
       * 如果 ID 是真实的（如 "id:101" 或 101）：直接使用。
     * type == "link"：执行数据库更新操作，建立外键关联。例如：UPDATE topic SET parent_stage_id = {tgt} WHERE topic_id = {src}。
     * type == "unlink"：将对应外键置空或删除关联记录。
* **Narration_status 表配置更新**：写入表 narration_status，（为此 user_id）赋值：
  * stn_llm_session_id == LLM 返回的 session id
  * stn_llm_session_previous_response_id == LLM 返回的 previous_response_id
  * stn_session_word_count == 自增 LLM 返回文本字数
  * stn_unprocessed_content 置空 // 清除处理失败的内容
* **Storyboard 赋值：**
  1. 更新旧记录状态：将 story_board 表中 story_id <= max_stn_read_id 且 user_id == 当前用户 的记录 stn_processed_status 置为 1。
  2. 格式化并写入新记录：
     * 数据源：取本次处理中成功入库的实体（即 pt 为 n 或 u 的数据）。
     * **字段赋值（entity_id 与 story_type）：**
       * 写入时需根据当前实体类型，将刚刚入库生成的真实主键 ID 赋值给 entity_id：
         * 若为 Stage：story_type = 1，entity_id = stage_id
         * 若为 Topic：story_type = 2，entity_id = topic_id
         * 若为 Shot：story_type = 3，entity_id = shot_id
         * 若为 Character：story_type = 4，entity_id = character_id
     * **格式要求与解析逻辑（story_content）：**
       * 后端需遍历 JSON 中的 R (Relation) 数组，找到当前实体（Src）指向的父级实体（Tgt，type="link"）。
       * Topic：
         * 拼接逻辑：在 R 数组中找到 src=当前Topic_ID 且 target 为 Stage 类型的记录，提取该 Stage ID 作为“父级ID”。
         * 拼接格式：[T:{Topic_ID} S:{父级Stage_ID}] {Title} | {Summary}
       * Shot：
         * 拼接逻辑：在 R 数组中找到 src=当前Shot_ID 且 target 为 Topic 类型的记录，提取该 Topic ID 作为“父级ID”。
         * 拼接格式：[O:{Shot_ID} T:{父级Topic_ID}] {Title} | {Content}
       * Character：
         * 拼接逻辑：同理，从 R 中找到关联的 Shot ID。
         * 拼接格式：[C:{Character_ID} O:{关联Shot_ID}] {Name} | {Relation}
     * **注意**：若在 R 数组中未找到父级关联，则父级 ID 填 "NULL" 或 "0"，确保格式统一。
* **调用 dir Agent：**异步调用 dir Agent，并将 user_id 传入。
## 3. Dir agent（导演）工作流
1. **并发控制**：
   * 基于 User_ID 的任务队列：系统需维护一个针对该用户的串行任务队列（FIFO）。
   * 入队逻辑：当 Stn Agent 触发 Dir 请求时，若该用户当前无正在执行的 Dir 任务，则立即执行；若已有任务在运行，则将新请求放入队列等待。
   * 出队执行：当前任务执行完毕（无论成功写入数据库还是发生异常报错）后，系统必须自动检查队列，若有积压任务，则取出下一条继续执行，确保同一用户的 Dir 任务严格按顺序单线程处理。
2. **Session 处理**：先判断是否有可用的 dir_session。
   * 判断条件：查阅 narration_status 表（此 user_id），满足以下任一条件则视为**无可用** dir_session：
     * dir_llm_session_id 为空；// 还没有创建过
     * dir_llm_session_word_count > {{config.dir_llm_session_word_limit}}；// 字数超限
     * dir_llm_session_expire_at - 当前时间 < {{config.dir_llm_session_expire_buf}}；// 时间即将超限
   * 若有可用 session:
     * **获取 storyboard 未处理记录**：dir_storyboard_context == 查询 storyboard 表，（此 user_id）dir_processed_status == 0，按照 created_time 正序排列，将 story_content 全量拼接。在拼接内容的同时，记录下这批数据中**最大的 ID**，记为变量 max_dir_read_id。
     * **更新 narration_status 表**，赋值（此 user_id ）：dir_llm_session_word_count == 已有字数 + dir_storyboard_context 字数 + 本轮 cachepool_content 的字数
   * 若无可用 session，则：
     1. **获取 Storyboard 完整记录**：dir_storyboard_context == 查询 storyboard 表，（此 user_id）按 created_time 倒序取 {{config.max_sb_context}} 条记录（随后恢复正序），将 story_content 全量拼接。
     2. 新建或重置（dir 的）session 信息，在 narration_status 表中（为此 user_id）赋值：
        * dir_llm_session_word_count == dir_storyboard_context 字数
        * dir_llm_session_expire_at == 当前时间 +{{config.dir_llm_session_expire_duration}}；// 设置新的过期时间。
     3. 切断旧 session 的联系：dir_llm_session_previous_response_id 置为空。
3. **配置本轮 dir_llm_input**：
   * 取 prompt：在 prompt_config 表中，取 llm_type == 2 且 is_active == ture 且 prompt_id 最大的记录，dir_prompt == prompt_content；
   * 需要判断本轮 stn LLM 对话是否新建了 session：
     * 若新建了 session， dir_llm_input == [ {role: system, content: dir_prompt}, {role: user, content: dir_storyboard_context}
     * 若未新建 session， dir_llm_input == [ {role: user, content: dir_storyboard_context}
4. **调用 dir LLM Response API**：
   * 入参：
     * model_id == 查询 base_models 表获取 api_model_id（条件：model_id == {{config.dir_llm_model}}）；
     * input == dir_llm_input；
     * previous_response_id == dir_llm_session_previous_response_id（为空则不传）；
     * expire_at == dir_llm_session_expire_at；
     * temperature == {{config.dir_llm_temp}}。
   * 判断 LLM 是否回复成功：
     * 若 LLM 返回了内容，则判定为回复成功。此时进入下一步；
     * 若 LLM 回复报错，则重试 2 次调用。若仍然回复失败，则：后端提示“诶？刚才念念记东西时开了个小差（dirllmRE）”；
5. **Dir 输出成功后的处理**：
   * 记录 Dir LLM 调用： 根据模型返回的 token 消耗，写入 LLM_processed 表，赋值：
     * agent == "dir"
     * model_id == {{config.dir_llm_model}}（直接存配置项中的内部 ID）
     * process_duration == 从调用到成功收到回复的时长，由系统计算，单位：毫秒
     * total_tokens == SDK 返回的 total_tokens
     * prompt_tokens == SDK 返回的 prompt_tokens
     * completion_tokens == SDK 返回的 completion_tokens
     * cached_tokens == SDK 返回的 cached_tokens
   * 写入 hintboard：在 hintboard 表，新建一条记录，hint_content == dir_text（dir llm 的回复）
   * Narration_status 表配置更新：写入表 narration_status，（为此 user_id）赋值：
     * dir_llm_session_id == LLM 返回的 session id
     * dir_llm_session_previous_response_id == LLM 返回的 previous_response_id
     * dir_session_word_count == 自增LLM 返回文本字数
   * 更新 storyboard 处理状态：将 storyboard 表中
     * 筛选条件：user_id == 当前用户 且 dir_processed_status == 0 且 story_id <= max_dir_read_id 的全部记录；
     * 赋值：dir_processed_status = 1。

# 四、数据库设计
## 1. 系统配置
### sys_config（系统配置表）
| **字段名**      | **字段类型**     | **约束**   | **取值标准 / 示例**          | **说明 (注释)**            |
|--------------|--------------|----------|------------------------|------------------------|
| config_key   | VARCHAR(64)  | PK       | session_ttl            | 配置项目英文字段名 (代码调用唯一 Key) |
| config_name  | VARCHAR(64)  | NOT NULL | Session 有效时长           | 配置项目中文名 (管理后台显示名称)     |
| config_value | TEXT         | NOT NULL | 3600                   | 当前生效的配置值               |
| config_type  | VARCHAR(32)  | NOT NULL | number / text / select | 控件类型 (用于管理后台界面渲染)      |
| remark       | VARCHAR(255) | -        | 单位：秒                   | 详细注释说明                 |
| updated_time | TIMESTAMPTZ  | -        | now()                  | 最后一次修改时间               |
### base_models（模型库表）
| **字段名** | **字段类型** | **约束** | **取值标准 / 示例** | **说明 (注释)** |
|---|---|---|---|---|
| model_id | BIGSERIAL | PK | 1 | 自增主键 |
| model_name_cn | VARCHAR(64) | NOT NULL | 豆包-Pro | 中文名 |
| model_name_en | VARCHAR(64) | NOT NULL | Doubao-Pro-32k | 模型英文名称 (用于技术唯一标识) |
| model_type | VARCHAR(32) | NOT NULL | LLM / ASR / TTS | 模型类型 |
| api_model_id | VARCHAR(128) | NOT NULL | ep-2024... | 后端调用 API 的真实标识 |
| input_price | DECIMAL(10,4) | - | 0.8 | 输入单价 (对应计费基数) |
| output_price | DECIMAL(10,4) | - | 2 | 输出单价 (ASR/TTS填0) |
| cache_discount | DECIMAL(10,2) | Default: 0.5 | 0.5 | 缓存计费折扣 (如：0.5 代表 5 折) |
| cache_storage_price | DECIMAL(10,4) | - | 0.01 | 缓存存储单价 (元/百万Token/小时) |
| cluster_id | VARCHAR(64) | - | v-2024... | 集群 ID |
| remark | VARCHAR(255) | - | 主推理模型 | 备注信息 |
### prompt_config（提示词配置）
| **字段名**        | **字段类型**     | **约束**        | **取值标准 / 示例**        | **说明 (注释)**  |
|----------------|--------------|---------------|----------------------|--------------|
| prompt_id      | BIGSERIAL    | PK            | 1                    | 自增主键         |
| llm_type       | SMALLINT     | NOT NULL      | 0:Intv, 1:Stn, 2:Dir | 对应 LLM       |
| prompt_content | TEXT         | -             | # 背景与身份设定            | 提示词内容        |
| remark         | VARCHAR(255) | -             | 修复了 JSON 解析报错        | 版本备注         |
| is_active      | BOOLEAN      | Default: True | True / False         | 是否启用（方便快速回滚） |
| created_time   | TIMESTAMPTZ  | NOT NULL      | now()                | 提示词创建时间      |
## 2. 用户与权限管理
### users（用户表）
| **字段名**             | **字段类型**    | **约束**           | **取值标准 / 示例**     | **说明 (注释)** |
|---------------------|-------------|------------------|-------------------|-------------|
| user_id             | UUID        | PK               | -                 | 用户唯一标识      |
| user_name           | VARCHAR(64) | NOT NULL         | 啊拓                | 系统中的用户名称    |
| redeem_code         | CHAR(4)     | -                | 0659              | 备用          |
| wechat_openid       | VARCHAR(64) | Unique, NOT NULL | oUpf_5X...        | 微信 OpenID   |
| wechat_unionid      | VARCHAR(64) | Unique           | b7as_9Z...        | 微信 UnionID  |
| wechat_nickname     | VARCHAR(64) | -                | 张三                | 微信昵称        |
| wechat_avatar_url   | TEXT        | -                | https://.../a.jpg | 微信头像 URL    |
| wechat_phone_number | VARCHAR(20) | -                | 13800138000       | 微信手机号       |
| user_profile        | TEXT        | -                | 退休教师，爱好摄影         | 用户个人简介      |
| birth_year          | INTEGER     | -                | 1965              | 出生年份        |
| birth_month         | SMALLINT    | -                | 10                | 出生月份        |
| gender              | SMALLINT    | Default: 0       | 0:未知, 1:男, 2:女    | 性别          |
| user_type           | SMALLINT    | Default: 0       | 0:内测, 1:普通        | 用户账号类型      |
| created_time        | TIMESTAMPTZ | NOT NULL         | now()             | 账号创建时间      |
## 3. 回忆核心容器
### stage（舞台表）
| **字段名** | **字段类型** | **约束** | **取值标准 / 示例** | **说明 (注释)** |
|---|---|---|---|---|
| stage_id | BIGSERIAL | PK | 1, 2, 3... | 舞台唯一 ID |
| user_id | UUID | FK(users), Index | - | 关联用户 |
| stage_title | VARCHAR(255) | NOT NULL | 故乡的童年 | 舞台标题 |
| stage_summary | TEXT | - | 1970-1980年间的家乡生活 | 简要总结 |
| stage_content | TEXT | - | 详细描述了家属院... | 详细描述 |
| stage_start_time | VARCHAR(64) | - | 1970年 | 阶段开始时间 |
| stage_end_time | VARCHAR(64) | - | 1980年 | 阶段结束时间 |
| created_time | TIMESTAMPTZ | NOT NULL | now() | 创建时间 |
### topic（话题表）
| **字段名** | **字段类型** | **约束** | **取值标准 / 示例** | **说明 (注释)** |
|---|---|---|---|---|
| topic_id | BIGSERIAL | PK | 1, 2, 3... | 话题唯一 ID |
| user_id | UUID | FK(users), Index | - | 关联用户 |
| parent_stage_id | BIGINT | FK(stage) | 1 | 从属的舞台 ID |
| topic_title | VARCHAR(255) | NOT NULL | 后山的防空洞 | 话题标题 |
| topic_summary | TEXT | - | 小伙伴们探险的秘密基地 | 简要总结 |
| topic_content | TEXT | - | 描述了防空洞的结构... | 详细描述 |
| created_time | TIMESTAMPTZ | NOT NULL | now() | 入库时间 |
### shot（镜头表）
| **字段名**         | **字段类型**     | **约束**           | **取值标准 / 示例**              | **说明 (注释)** |
|-----------------|--------------|------------------|----------------------------|-------------|
| shot_id         | BIGSERIAL    | PK               | 1, 2, 3...                 | 镜头唯一 ID     |
| user_id         | UUID         | FK(users), Index | -                          | 关联用户        |
| parent_topic_id | BIGINT       | FK(topic)        | 1                          | 从属的话题 ID    |
| shot_title      | VARCHAR(255) | NOT NULL, Index  | 洞穴飞出蝙蝠                     | 镜头标题        |
| shot_summary    | TEXT         | -                | 探险时受惊的瞬间                   | 镜头总结        |
| shot_content    | TEXT         | -                | 大家拿着手电筒，突然...              | 详细内容描述      |
| shot_type       | SMALLINT     | -                | 1=long, 2=close_up, 3=mono | 叙事类型(远/中/特) |
| created_time    | TIMESTAMPTZ  | NOT NULL         | now()                      | 创建时间        |
### character（人物表）
| **字段名** | **字段类型** | **约束** | **取值标准 / 示例** | **说明 (注释)** |
|---|---|---|---|---|
| character_id | BIGSERIAL | PK | 1, 2, 3... | 人物唯一 ID |
| user_id | UUID | FK(users), Index | - | 关联用户 |
| related_shot_id | BIGINT | FK(shot) | 5 | 关联的镜头 ID |
| name | VARCHAR(64) | NOT NULL | 外婆 | 姓名或称呼 |
| relation | VARCHAR(64) | - | 祖孙 | 与用户的关系 |
| evaluation | TEXT | - | 非常慈祥，做糕点很好吃 | 对该人物的评价 |
| created_time | TIMESTAMPTZ | NOT NULL | now() | 创建时间 |
## 4. 系统运行与 Agent 逻辑
### narration_status（讲述状态表）
| 字段名                                   | 字段类型         | 约束                      | 取值标准 / 示例                                                  | 说明 (注释)                         |
|---------------------------------------|--------------|-------------------------|------------------------------------------------------------|---------------------------------|
| narration_status_id                   | BIGSERIAL    | PK                      | 1, 2, 3…                                                   | 状态记录自增 ID                       |
| user_id                               | UUID         | FK(users), Unique Index | -                                                          | 关联用户                            |
| intv_llm_session_id                   | UUID         | -                       | -                                                          | LLM SDK 返回的 Session ID (采访员)    |
| stn_llm_session_id                    | UUID         | -                       | -                                                          | LLM SDK 返回的 Session ID (速记员)    |
| dir_llm_session_id                    | UUID         | -                       | -                                                          | LLM SDK 返回的 Session ID (导演)     |
| intv_llm_hint_id                      | BIGINT       | -                       | 15                                                         | 关联 hintboard 表主键，Intv 当前认知的最新提示 |
| intv_llm_session_word_count           | INTEGER      | Default: 0              | 1500                                                       | Intv LLM 当前 session 的总字数        |
| stn_llm_session_word_count            | INTEGER      | Default: 0              | 2300                                                       | Stn LLM 当前 session 的总字数         |
| dir_llm_session_word_count            | INTEGER      | Default: 0              | 800                                                        | Dir LLM 当前 session 的总字数         |
| intv_llm_session_expire_at            | TIMESTAMPTZ  | -                       | 2025-01-02 12:00:00+08                                     | Intv LLM 当前 session 的过期时间       |
| stn_llm_session_expire_at             | TIMESTAMPTZ  | -                       | 2025-01-02 12:00:00+08                                     | Stn LLM 当前 session 的过期时间        |
| dir_llm_session_expire_at             | TIMESTAMPTZ  | -                       | 2025-01-02 12:00:00+08                                     | Dir LLM 当前 session 的过期时间        |
| chat_cachepool_content                | TEXT         | -                       | U:你好 I:您好...                                               | 对话缓存池临时内容，处理后清空                 |
| intv_llm_previous_content             | TEXT         |                         | U:你好 I:您好...                                               | Intv LLM 新建session时的前情提要        |
| stn_unprocessed_content               | TEXT         | -                       | U:刚才说到了...                                                 | Stn 处理失败/报错时的原始内容备份             |
| intv_llm_session_previous_response_id | VARCHAR(128) | -                       | resp_0217661267019147d8950efa0e2f7c9d9cc7a1cc971272cf4548c | 流程中必需：Intv 上一轮对话的 msg_id        |
| stn_llm_session_previous_response_id  | VARCHAR(128) | -                       | resp_0217661267019147d8950efa0e2f7c9d9cc7a1cc971272cf4548c | 流程中必需：Stn 上一轮对话的 msg_id         |
| dir_llm_session_previous_response_id  | VARCHAR(128) | -                       | resp_0217661267019147d8950efa0e2f7c9d9cc7a1cc971272cf4548c | 流程中必需：Dir 上一轮对话的 msg_id         |
### storyboard（故事表）
| **字段名**              | **字段类型**    | **约束**                                                       | **取值标准 / 示例**         | **说明 (注释)**                                                  |
|----------------------|-------------|--------------------------------------------------------------|-----------------------|--------------------------------------------------------------|
| story_id             | BIGSERIAL   | PK                                                           | -                     | 自增 ID                                                        |
| user_id              | UUID        | FK(users), Composite Index(user_id, stn_processed_status), Composite Index(user_id, dir_processed_status) | -                     | 关联用户                                                         |
| story_type           | SMALLINT    | Index                                                        | 1:S, 2:T, 3:O, 4:C    | 系统逻辑使用此字段判断条目类型，story_content 中的类型标记仅服务于 LLM 可读性，便于正确识别层级关系。 |
| entity_id            | BIGINT      | Index                                                        | 10                    | 对应各表(S/T/O/C)的主键ID                                           |
| story_content        | TEXT        | -                                                            | [T:102 S:50] 标题 \| 总结 | 总结`                                                          |
| stn_processed_status | SMALLINT    | Default: 0                                                   | 0:未处理, 1:成功           | 速记员处理状态                                                      |
| dir_processed_status | SMALLINT    | Default: 0                                                   | 0:未处理, 1:成功           | 导演处理状态                                                       |
| created_time         | TIMESTAMPTZ | NOT NULL                                                     | now()                 | 创建时间                                                         |
### hintboard（导演提示问题表）
| **字段名**      | **字段类型**    | **约束**                                                 | **取值标准 / 示例** | **说明 (注释)** |
|--------------|-------------|--------------------------------------------------------|---------------|-------------|
| hint_id      | BIGSERIAL   | PK                                                     | -             | 自增 ID       |
| user_id      | UUID        | FK(users), Composite Index(user_id, created_time DESC) | -             | 关联用户        |
| hint_content | TEXT        | NOT NULL                                               | 可以多聊聊关于...    | 导演生成的指令文本   |
| created_time | TIMESTAMPTZ | NOT NULL                                               | now()         | 创建时间        |
## 5. 模型调用记录表
### LLM_processed（ LLM 大语言模型调用记录表）
| **字段名**                  | **字段类型**       | **约束**                                                       | **取值标准 / 示例**    | **说明 (注释)**                             |
|--------------------------|----------------|--------------------------------------------------------------|------------------|-----------------------------------------|
| model_processed_id       | BIGSERIAL      | PK                                                           | -                | 调用记录 ID                                 |
| user_id                  | UUID           | FK(users)                                                    | -                | 关联用户                                    |
| agent                    | VARCHAR(64)    | -                                                            | Intv / Stn / Dir | Agent 角色                                |
| model_id                 | BIGINT         | FK(base_models)                                              | 1                | 关联 base_models 表主键                      |
| model_name_cn            | VARCHAR(64)    | NOT NULL                                                     | 豆包-Pro           | 模型中文名称                                  |
| related_original_text_id | BIGINT         | REFERENCES interview_original_text(interview_original_text_id) | 12345 或 NULL	    | 关联的用户原始输入记录 ID，用于追溯本次 LLM 调用是由哪条用户输入触发的 |
| input                    | TEXT           | -                                                            | -                | 请求 LLM 的输入原文                            |
| output                   | TEXT           | -                                                            | -                | 请求 LLM 的输出原文                            |
| process_duration         | INTEGER        | -                                                            | 1500             | 调用总耗时 (ms)                              |
| processed_cost           | DECIMAL(10, 4) | -                                                            | 0.02             | 本次消耗金额                                  |
| total_tokens             | INTEGER        | -                                                            | 850              | 消耗总 Token 数                             |
| prompt_tokens            | INTEGER        | -                                                            | 850              | 输入给模型处理的内容 Token 数量（含用户提问、历史对话等上下文）。    |
| completion_tokens        | INTEGER        | -                                                            | 850              | 模型输出内容消耗的 Token 数量（含回答文本、思维链等）。         |
| cached_tokens            | INTEGER        | -                                                            | 850              | 缓存输入内容的 Token 用量。                       |
| created_time             | TIMESTAMPTZ    | NOT NULL                                                     | now()            | 创建时间                                    |
### ASR_processed（ASR 语音转文字调用记录表）
| **字段名**          | **字段类型**      | **约束**       | **取值标准 / 示例** | **说明 (注释)**    |
|------------------|---------------|--------------|---------------|----------------|
| processed_id     | BIGSERIAL     | PK（主键）      | 自增唯一          | 语音处理记录唯一 ID    |
| original_text_id | BIGINT        | FK（外键）      | 关联有效值         | 关联访谈文本表的 ID    |
| model_id         | BIGINT        | FK           | 2             | 关联 base_models |
| duration         | INTEGER       | 无            | 5             | 语音时长（单位：s）    |
| processed_cost   | DECIMAL(10,6) | -            | 0.002         | 本次计算出的总金额      |
| created_time     | TIMESTAMPTZ   | NOT NULL（非空）| now ()        | 语音处理记录创建时间     |
### TTS_processed（TTS 文字转语音调用记录表）
| **字段名**                | **字段类型**      | **约束**       | **取值标准 / 示例** | **说明 (注释)**    |
|------------------------|---------------|--------------|---------------|----------------|
| processed_id           | BIGSERIAL     | PK（主键）      | 自增唯一          | 语音处理记录唯一 ID    |
| link_original_text_id  | BIGINT        | FK（外键）      | 关联有效值         | 关联采访原文表的 ID    |
| link_original_voice_id | BIGINT        | FK（外键）      | 关联有效值         | 关联采访音频表的 ID    |
| model_id               | BIGINT        | FK           | 2             | 关联 base_models |
| duration               | INTEGER       | 无            | 5             | 语音时长（单位：s）    |
| processed_cost         | DECIMAL(10,6) | -            | 0.002         | 本次计算出的总金额      |
| created_time           | TIMESTAMPTZ   | NOT NULL（非空）| now ()        | 语音处理记录创建时间     |
## 6. 采访溯源
### interview_original_text（采访原文表）
| **字段名**                    | **字段类型**    | **约束**                                                 | **取值标准 / 示例** | **说明 (注释)**      |
|----------------------------|-------------|--------------------------------------------------------|---------------|------------------|
| interview_original_text_id | BIGSERIAL   | PK                                                     | -             | 原文唯一 ID          |
| user_id                    | UUID        | FK(users), Composite Index(user_id, created_time DESC) | -             | 关联用户             |
| speaker_type               | SMALLINT    | NOT NULL                                               | 0:用户, 1:AI    | 说话人类型            |
| has_voice                  | BOOLEAN     | Default: False                                         | True / False  | 标识本条对话是否有对应的录音文件 |
| original_text              | TEXT        | NOT NULL                                               | 那天雪下得很大       | 原始对话文本           |
| created_time               | TIMESTAMPTZ | NOT NULL                                               | now()         | 创建时间             |
### interview_original_voice（采访音频表）
| **字段名**                     | **字段类型**    | **约束**                      | **取值标准 / 示例**        | **说明 (注释)** |
|-----------------------------|-------------|-----------------------------|----------------------|-------------|
| interview_original_voice_id | BIGSERIAL   | PK                          | -                    | 音频唯一 ID     |
| user_id                     | UUID        | FK(users), Index            | -                    | 关联用户        |
| speaker_type                | SMALLINT    | NOT NULL                    | 0:用户, 1:AI           | 说话人类型       |
| link_original_text_id       | BIGINT      | FK(interview_original_text) | -                    | 关联的原文 ID    |
| original_voice_url          | TEXT        | NOT NULL                    | https://cos.../v.mp3 | 音频存储 URL    |
| created_time                | TIMESTAMPTZ | NOT NULL                    | now()                | 创建时间        |

